generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Business Manager Account
model Account {
  id          String   @id @default(uuid())
  name        String
  businessId  String   @unique // WhatsApp Business Manager ID
  accessToken String   @db.Text // Meta API Access Token
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  numbers   Number[]
  campaigns Campaign[]

  @@map("accounts")
}

// WhatsApp Phone Numbers
model Number {
  id              String   @id @default(uuid())
  phoneNumber     String   @unique // Format: +5511999999999
  phoneNumberId   String   @unique // WhatsApp Phone Number ID from Meta
  displayName     String?
  qualityRating   String? // HIGH, MEDIUM, LOW
  verifiedName    String?
  isActive        Boolean  @default(true)
  accountId       String
  queueKey        String?
  segments        String[] @default([])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  account       Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaigns     Campaign[]
  conversations Conversation[]
  messages      Message[]
  templates     Template[]
  presences     OperatorPresence[]
  events        ConversationEvent[]

  @@map("numbers")
}

// Operators (Agents)
model Operator {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  isActive      Boolean  @default(true)
  maxConcurrent Int      @default(5) // Max concurrent conversations
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  conversations Conversation[]
  presence      OperatorPresence?
  events        ConversationEvent[]

  @@map("operators")
}

model OperatorPresence {
  id             String   @id @default(uuid())
  operatorId     String   @unique
  numberId       String?
  queueKey       String?
  connectedUrl   String?
  segments       String[] @default([])
  isOnline       Boolean  @default(false)
  startedAt      DateTime @default(now())
  lastHeartbeat  DateTime @default(now())
  lastAssignedAt DateTime @default(now())
  expiresAt      DateTime?

  operator Operator @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  number   Number?  @relation(fields: [numberId], references: [id], onDelete: SetNull)

  @@map("operator_presence")
}

// Message Templates (WhatsApp Approved Templates)
model Template {
  id           String   @id @default(uuid())
  name         String
  language     String   @default("pt_BR")
  category     String // MARKETING, UTILITY, AUTHENTICATION
  templateId   String   @unique // WhatsApp Template ID
  status       String // APPROVED, PENDING, REJECTED
  components   Json // Template structure (header, body, footer, buttons)
  variables    String[] // Variable placeholders like {{1}}, {{2}}
  numberId     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  number   Number?   @relation(fields: [numberId], references: [id], onDelete: SetNull)
  campaigns Campaign[]

  @@map("templates")
}

// Campaigns (Bulk Message Sending)
model Campaign {
  id                String   @id @default(uuid())
  name              String
  description       String?
  templateId        String
  accountId         String
  numberId          String
  csvFilePath       String // Path to uploaded CSV file
  queueKey          String?
  originUrl         String?
  segments          String[] @default([])
  totalRecipients   Int      @default(0)
  sentCount         Int      @default(0)
  deliveredCount    Int      @default(0)
  readCount         Int      @default(0)
  failedCount       Int      @default(0)
  status            String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  rateLimit         Int      @default(50) // Messages per minute
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id])
  account  Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  number   Number   @relation(fields: [numberId], references: [id])
  contacts CampaignContact[]
  events   ConversationEvent[]

  @@map("campaigns")
}

// Conversations (Chat Sessions)
model Conversation {
  id              String    @id @default(uuid())
  customerPhone   String // Customer's phone number
  customerName    String?
  customerContract String?
  customerCpf     String?
  numberId        String // WhatsApp number handling this conversation
  operatorId      String? // Assigned operator
  status          String    @default("OPEN") // OPEN, CLOSED, PENDING_CLOSURE
  tabulationId    String? // Closure categorization
  notes           String? // Operator notes
  lastMessageAt   DateTime  @default(now())
  closedAt        DateTime?
  lastAssignedAt  DateTime?
  lastAgentMessageAt    DateTime?
  lastCustomerMessageAt DateTime?
  manualAttemptsCount   Int       @default(0)
  manualAttemptsWindowStart DateTime?
  manualBlockedUntil    DateTime?
  cpcMarkedAt           DateTime?
  cpcMarkedBy           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  number      Number      @relation(fields: [numberId], references: [id])
  operator    Operator?   @relation(fields: [operatorId], references: [id])
  tabulation  Tabulation? @relation(fields: [tabulationId], references: [id])
  messages    Message[]
  events      ConversationEvent[]

  @@index([customerPhone, numberId])
  @@index([operatorId])
  @@index([status, operatorId])
  @@index([manualBlockedUntil])
  @@index([status])
  @@map("conversations")
}

// Messages (Individual Messages)
model Message {
  id              String    @id @default(uuid())
  conversationId  String?
  numberId        String
  messageId       String?   @unique // WhatsApp Message ID
  wamid           String?   @unique // WhatsApp Message ID (alternative format)
  direction       String // INBOUND, OUTBOUND
  type            String // text, image, video, audio, document, template, location
  content         Json // Message content (varies by type)
  status          String?   @default("SENT") // SENT, DELIVERED, READ, FAILED (for outbound)
  fromPhone       String // Sender phone number
  toPhone         String // Recipient phone number
  timestamp       DateTime  @default(now())
  errorCode       String?
  errorMessage    String?
  metadata        Json? // Additional metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  number       Number        @relation(fields: [numberId], references: [id])
  events       ConversationEvent[]

  @@index([conversationId])
  @@index([messageId])
  @@index([fromPhone])
  @@index([timestamp])
  @@map("messages")
}

model CampaignContact {
  id             String   @id @default(uuid())
  campaignId     String
  phoneNumber    String
  customerName   String?
  contractCode   String?
  customerCpf    String?
  rawPayload     Json?
  status         String   @default("PENDING")
  lastAttemptAt  DateTime?
  lastSentAt     DateTime?
  lastStatusAt   DateTime?
  failedReason   String?
  cpcMarkedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  events   ConversationEvent[]

  @@unique([campaignId, phoneNumber])
  @@index([phoneNumber])
  @@map("campaign_contacts")
}

model ConversationEvent {
  id                String   @id @default(uuid())
  conversationId    String?
  messageId         String?
  campaignId        String?
  campaignContactId String?
  numberId          String?
  operatorId        String?
  phoneNumber       String
  source            ConversationEventSource
  direction         ConversationEventDirection
  eventType         ConversationEventType
  payload           Json?
  cpcMarked         Boolean  @default(false)
  tabulationId      String?
  createdAt         DateTime @default(now())

  conversation Conversation?   @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  message      Message?        @relation(fields: [messageId], references: [id], onDelete: SetNull)
  campaign     Campaign?       @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  campaignContact CampaignContact? @relation(fields: [campaignContactId], references: [id], onDelete: SetNull)
  number       Number?         @relation(fields: [numberId], references: [id], onDelete: SetNull)
  operator     Operator?       @relation(fields: [operatorId], references: [id], onDelete: SetNull)
  tabulation   Tabulation?     @relation(fields: [tabulationId], references: [id], onDelete: SetNull)

  @@index([phoneNumber])
  @@index([createdAt])
  @@index([conversationId, createdAt])
  @@index([campaignId, createdAt])
  @@map("conversation_events")
}

enum ConversationEventSource {
  CUSTOMER
  OPERATOR
  CAMPAIGN
  SYSTEM
}

enum ConversationEventDirection {
  INBOUND
  OUTBOUND
  NONE
}

enum ConversationEventType {
  MESSAGE
  TABULATION
  CPC
  NOTE
}

// Tabulations (Conversation Categories)
model Tabulation {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String?
  requiresNotes Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  conversations Conversation[]
  events        ConversationEvent[]

  @@map("tabulations")
}

// Webhook Events Log (for debugging)
model WebhookEvent {
  id          String   @id @default(uuid())
  eventType   String // message, status, etc.
  payload     Json
  processed   Boolean  @default(false)
  error       String?
  createdAt   DateTime @default(now())

  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events")
}
